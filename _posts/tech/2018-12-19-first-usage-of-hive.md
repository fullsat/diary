---
title:  "About my first usage of Hive"
date:   2018-12-19 10:00:00 +0900
category: tech
tags: aws hive emr
layout: post
---

ひょんなことからHiveを使うことができたのでその時のちょっとしたまとめです。

一時的かつ、超大急ぎで調査＆利用の流れだったため、
技術的なことをほとんど調べられずに利用だけしたようなものでした。
そのため、あまり技術的なことは書けませんが、
改めて調査するときのためにどのようなことを調べれば良さそうか知るためにまとめます。

## 目的

とある理由で以下のことをしなければならなくなった。

* DynamoDBのレコードから特定条件のリストを作らなければいけない
* 対象のテーブルのレコード数は1億以上

## 手段

### 最初に考えた手段

DynamoDBに対して並列スキャンを実行し対象の条件のリストを作成する。

検索する条件が比較的簡単だったためスクリプトはすぐに実装できなくはない。

しかし並列実行でもう一つ難が出てくるのがクラスタの仕組みを作るところ。

超大急ぎでやらなければならなかったため、

* クラスタを作る
* スクリプトを書く

この2つをやってる暇がなかった

### EMR + Hive + DynamoDB

前述した手段を一気に解決してくれたのがこれ

* クラスタを作る => EMRがやってくる
* スクリプトを書く => 単純なHiveQLを書けばいい(分散までしてくれる)

EMR + Hive + DynamoDBの手段で行うことは

* EMRを調べる
 
だけ。

EMRを調べる時間のほうがかかるのではないか、と考えたが、
Hive + DynamoDBに関する先行事例とチュートリアルがあったため、
そこまで時間がかからないと判断しました。

## やったこと

* Amazon公式チュートリアルを試す
* クラスメソッドの記事を参考にして試す
* 実際に動かすクエリを試す
* クラスタのコアの台数を増やし並列実行されるか調べる
* クラスタのコアの台数を決めてコンソール上から本番に対して実行する
* クエリの実行をステップ化する

## わかったこと

* EMRのクラスタの構築の仕方
* コンソールからやるときは詳細オプションに移動するからやらないとVPC内に作れないなどいろいろ制約がある
* ステップはバッチ処理のようにクラスタを動かすこと
* SecurityGroupはマスター/コア/タスク、EMRマネージドセキュリティグループに関して別々のものを設定しないといけない
* DynamoDBに対する集計が爆速である
  * オンデマンドキャパシティ + スポットインスタンスの組み合わせでかなりのコスト節約が見込める

## わからないこと

* DynamoDBへのアクセスがどう分散されているか
* MapReduceはどんなクエリを発行する際効果的なのか
* HiveQLに対して実行したexplainの実行計画の見方
* EMR上にHadoopで使えるミドルウェアがいっぱい乗っかってるという認識で良いのか
* EMRのサービスタスクが有用なタイミングはいつなのか
* EMRが必要になるほどのデータはどの程度のオーダーなのか

## 参考にしたURL

https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/EMRforDynamoDB.Tutorial.html
https://dev.classmethod.jp/cloud/aws/emr-dynamo/
