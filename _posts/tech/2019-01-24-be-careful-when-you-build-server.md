---
title:  "サーバ構築時に気を付けたいこと"
date:   2019-01-24 22:00:00 +0900
category: tech
tags: poem infrastructure
layout: post
---

私が構築したサーバじゃないのに、なぜか私が監視の設計をしていることが多いことに気づきました。

そういうサーバはアプリケーションの特性がわかりません。

そういう時は、たぶんこういうことだよな、と思いながら、こういう監視でどうですか？と提案しています。

このことの是非は置いておいて、さらに思い返すと、監視に限らず、これ考えましたか？と聞き返すことが多いことにも気づきました。

それをちょっとまとめてみようかなと思います。

## 構築とは

仮想サーバ、OS、ミドルウェア、これらを必要な設定に変更する作業が構築であることに間違いはありません。

しかし、"運用のことを考えて"構築する、という条件を付けた場合はどうでしょう。

例えば、webサーバを構築してくださいといったときに、nginxを入れて、curlでレスポンスが返ってくることを確認するところまでやるのは当たり前のことかと思います。

運用を考えるとこれでは不十分なことは明らかです。

構築したwebサーバのログは吐き出しっぱなしでいいのか？負荷が上がっているかどうかどう確認するか？といったことが考慮されていません。

したがって、nginxだけでなく、logrotateの設定だとか、CloudWatchでの監視だとか、そういう設定も含めて構築というべきなのです。

そういうわけで、私が言うところの構築とは、運用を見据えた各種ミドルウェアの設定を行うことを構築と言います。

## 運用とは

運用を見据えるとは言っても、運用ってなんだ？と入社当初はなりました。

環境特有の運用はあるかもしれませんが、一般的な運用は以下の通りだと思います。

* 停止/起動/再起動
* ログの確認
* リソースの確認
* 監視
* 更新
* 不具合/障害時の対応
* 増設

### 停止/起動/再起動

これができなきゃそもそも使い捨てのサーバということになりますよね？

* ちゃんと停止/起動/再起動できるか
* 立ち上がっていることをどう確認するか
* 接続を切らずに再起動できるのか

設定ミスしてると、こういう単純なこともできなかったりします。

さすがに、この辺は確認されていることはほとんどですが、たまに忘れている人がいるように感じます。

### ログの確認

何か問題があったときなど必ずログを確認すると思います。

このログをちゃんと確認できるようにしておくのが普通です。

ただ、ログに関する設計は忘れやすいものの一つかなと思います。

出力/ローテーション/ログの保存/可視化 の設定はやっておくべきです。

例えば以下のようなことを考えておくといいと思います。

* ログが出力されっぱなしでディスクが圧迫することはないか
* あとで見やすい形で加工されているか
* ユーザの動きや障害対応時などログが確認しやすいようになっているか
* いつまでログを保存しておくのか

### リソースの確認

問題があったときにリソースの可視化ができていないと、何も手掛かりがない状態になります。

問題は必ず起こるものという前提のもと、リソースの確認はできるようにしておくべきだと思います。

たいていの場合、監視もリソースに紐づけて行うので、これができていないと監視すらできなくなります。

あと重要なのは、そのサーバにとって、ビジネスにとって、重要なメトリクスが構築するシステムに存在しないかといった点です。

作ってる人にしかわからないことが多いように思いますので、構築時に忘れると、あとでこれ取っておけばよかったとなります。

### 監視

問題があったかどうかはこれがないとやってられませんね。

四六時中サーバに張り付いてるわけにもいきません。

そういう意味では、監視設定がうまくできてないのは良くないですね。

たいていの場合、無駄にアラートが鳴ったりして、放置するといったことが出てきます。

何を監視しておくことが必要なのかは十分に議論するべきと思います。

最近気づいたのですが、たいていの場合OS周りのアラートは不要で、これらは後から見返せることが重要です。

本当に確認すべきは、たいていの場合レスポンスのステータスコードか、レスポンスタイムかなと思います。

ビジネス周りのメトリクスも一覧できると、パフォーマンスがビジネスに与える影響が可視化でき、開発の方針へと反映させやすいです。

### 更新

バージョンアップや、セキュリティアップデートなど、よほどの短命のサーバでない限り、必ず更新は入ります。

この時に更新の自動化はあきらめるとしても、手順がないと死ぬほどつらいです。

ただし、手順を予めまとめる人は、少なくとも私の所属している組織では稀です。

なので死ぬほどつらいです。

まとめられていないと、一から調べて、何に注意するかを考える必要が出てきます。

後でまとめるのはつらいので、作るときにまとめておくべきで、まとめられてなければまとめをお願いしています。

リファクタリングした方がいいところも発見できたりしてお得です。

### 不具合/障害時の対応

障害がないことはないという前提で自分は考えていますので、当然考慮するところだと思っています。

たいていの場合、どう対応していいのか、作った人じゃないとわかりません。

なので、自動化まではしないにしても、こういうときどうするのか、という疑問に思ったことは聞いて資料としてまとめをお願いしています。

障害対応にバックアップはつきものなので、これを考えてないとバックアップを取ることも忘れているということがあったりします。

### 増設

負荷が増えた場合は増設を考えます。

自動化されていれば最高ですが、自動化されていないのであれば手順書がないと１から作り直すのと変わりがありません。

ということで、初期構築の手順はどこかにまとめてもらいます。

Ansibleのコードがあれば最高です。

もちろん更新の手順や障害対応の手順もプレイブックにまとめてあれば最高なのは言うまでもありません。

ただ欲は言わないので、初期構築くらいはAnsibleで書かれていることを望んでいます。

## まとめ

```
yum install hogehoge
```

だったり

```
apt install hogehoge
```

だったりを行えば終わりではないのです。

インフラの構築では、運用を考えるのです。

初歩的なことだとは思うのですが、人間忘れるのです。

考慮していたけど抜けがあった、というのは、しょうがないという気も起きますが、
根本的に考慮していなかったというのは、素人だと思われてもしょうがないかもしれませんね。

私も他人ごとではありません。

私も人間なので、たまにすぽーん、と抜けることがあります。

と書いていて、チェックリストとしてまとめておこうかなとも思いました。

組織ごとにこういう観点をまとめてたりするのでしょうか？

そういうのがあれば教えてほしいものです。
