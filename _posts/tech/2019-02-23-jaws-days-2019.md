---
title:  "JAWS DAYS 2019へ参加した感想"
date:   2019-02-23 11:00:00 +0900
category: tech
tags: postgresql
layout: post
---

サメ映画こと(勝手に呼んでる)JAWS DAYS 2019に行ってきました。
その感想です。

内容はスライドがあるのでそれを見たほうが良いと思います。

発表内容に対してどう思ったのかをまとめます。

## 今日からはじめるCI/CD…のためのAWSアーキテクチャ事始め

[概要](https://jawsdays2019.jaws-ug.jp/session/2220/)

[スライド](https://speakerdeck.com/opelab/20190223-jawsdays-arch)

途中から見たので全体はよくわかりませんでした。

そんな中で印象に残ったのは、

* 目的を見失わないように
* CI/CDの先にはユーザがいる

この2点です。
これに関しては実感があります。

CI/CD進めていくと、多種多様なツールと格闘することになります。
それらに夢中になるあまり、もともとやりたかったことって何だったっけ？と分からなくなってきます。
個人的には早めにそこに気づいて、実現したいことを文章として残しておいたので、思い出してはそれを眺めています。

CI/CDは誰のために実現しているのか、ということを自問自答するのはよくあります。
当初はこういう開発の流れで行きましょう！という推奨ワークフローを定めていたのですが、
プロジェクトごとに開発の流れがあまりにも異なっているため、
現状にあわせないと非常につらいということがありました。

結局押し付けではなく、現状の開発フローに合わせて、CI/CDを実現する上で外せない所のみ変更ました。
開発者の負担を考えないと、結局だめになり、結果ユーザも不幸にするという流れになってしまいます。
新規開発ならともかく、既存の開発フローがある場合においては開発プロセスの標準化は後回しにしたほうが無難です。

## RDBリファクタリングと異種間DB移行の戦い – Amazon DMSを使った止めずにリファクタリングする手法

[概要](https://jawsdays2019.jaws-ug.jp/session/1108/)

[スライド](https://soudai.hatenablog.com/entry/2019/02/11/231106)

曽根さんだったので見ました。

* DBの寿命はアプリケーションより長い
  * アプリケーションが死んでもユーザ情報は残したいなど
* 1年半あればシステムは変わる
  * 謎のデータやテーブルが存在する
  * 制約ないし整合性が壊れてる
  * 非正規化によって複雑化したコード
* Refactoring Databases(本)が良い
* トリガーを使って肥大化したテーブルを分割する
  * MySQLは一つのテーブルに対し、同じイベントには複数トリガー適用できない
* Aurora PostgreSQLを選ばなかった理由
  * AuroraはOSSでは無い
  * 同じ環境を用意できない
  * Extensionの自作が出来ない
* AMS DMSを選んだ理由
  * 自分しか管理出来ないのでDMSを採用
* APIを用意してリファクタリングすることがオススメ
  * テストが書ける
  * Model単位で行こうができる
* DMSのデメリット
  * ローカルで実行できない
  * DMSが単一障害点
  * DMSのタスク上限がある

現状DBのマイグレーションの要件はないのでなるほどー、と聞いてました。
全体として感じたことは大まかに２つです。

* DBのリファクタにはAPIサーバを構築していくのが便利
* Refactoring Databasesの本を読みたい

私の環境でもバカみたいな数のレコードをJOINしていたりするようなので、リファクタが必要だと思います。
リファクタだと通らない案件も、APIサーバを構築しようという提案なら行ける気がしています。
そのついでにマイクロサービス化にもなるというすぐれものです。
DBの密結合をどうにかしたいと思っていたので、なんとか出来ないか模索してみようと思いました。

それに関連して、おすすめされた本を読みたいなと思いました。

## 実践！CloudFormation Best Practice ~CloudFormationで始める組織改革~

[概要](https://jawsdays2019.jaws-ug.jp/session/2004/)

[スライド](https://speakerdeck.com/y_muramoto_lvgs/shi-jian-cloudformation-best-practice-cloudformationdeshi-meruzu-zhi-gai-ge)

このセッションはだいたいやってるな、と思ったことが多かったです。

またterraformを使っていてもCloudFormationを使っていても考えることは一緒なんだなという気持ちです。

おそらくInfrastructure as Codeの本を読んでいればだいたい書いてあることです。

自分の場合は時代がすでに進んでいた状況だったので、もしかするとそれ以前に体験していることを発表していたのかもしれません。

* ライフサイクルでStackを分割する

これに関しては、VPCなどのいろいろなところから参照されるものと、サービス単位(マイクロサービスに近いもの)で分割するというルールを決めています。
依存関係は基本的に作らない方針で、common以外のところから参照はしません。
これをしないと話にあったとおり依存地獄に陥ります。

* 所有権でStackを分割する

これに関してはあまり考えていませんでした、なぜなら所有権はすべて自分だからです。

それでもサービス単位で分割しておけば、引き渡しは容易だと思っています。

* Templateを使う

私の環境ではこれをIAM周りで利用しています。

もちろんサービス内でしか使わないものはサービス内でtemplatesとしてディレクトリを切ります。

更に一般的に共通化するものはまた別にtemplatesとしてディレクトリを切っています。

自分の場合で言えば、これらのことは運用に載せる前に考えていたことなので、現状わりとうまく行っています。

## 技術力を上げたい！どうやって？ というか技術力って一体何なんだっけ？ – ハートビーツの場合

[概要](https://jawsdays2019.jaws-ug.jp/session/2182/)

[スライド](https://speakerdeck.com/netmarkjp/ji-shu-li-woshang-getai-douyatute-toiukaji-shu-li-tute-ti-he-nandatuke-hatobitufalsechang-he)

このセッションでは、技術力って何だ？という体系を紹介していました。

一つ疑問に思ったのは、ではそれを可視化、数値化するためにはどうすれば良いのか？といった所です。

健康の数値化は行けるかなと思います。

知識や価値の認識といった技能の部分も自己評価という形で数値化できると思いました。

ただし、マインドセットの部分が難しいなと思います。

マインドセットの部分で自己評価をするなら

* 詰めが甘い
* モチベーションの維持が難しい

といった課題があります。

これらを改善するための数値は何が良いのかなというところに応えは出ていません。

面白い試みだと思うので、数値化の部分も含めて考えて行こうかなと思います。

おそらくGQM手法を使えば行けると思っています。


## クラウド時代のモニタリングといえばDatadogだよね

[概要](https://jawsdays2019.jaws-ug.jp/session/1112/)

タイトルの通りDataDogかは置いておいて、Datadogの機能が多そうで個人的には興味を惹かれます。

使ってませんが・・・

個人的に気になったのは、APM、サーバメトリクス、ログを一緒に見れる機能？の部分です。

個人的に理想のダッシュボードができそうだなという印象を受けました。

だいたいの障害はレイテンシ、レスポンスコード(エラーの数)を監視すれば問題ないはずです。

その後に見たいのはAPMとサーバのメトリクスです。

これはどちらが悪いかを切り分けるために見ます。

最後に見たいのはログです。

切り分けた問題に対して、ログを見ればだいたい起こっていることが分かります。

これを一つのダッシュボードでできるような話を聞いて、良いなと思わないわけがありません。

使ってないと嘆きましたが、現状との優位性を示せれば利用できるはずなので、試験導入という形で使ってみたいなと思いました。

## 至高の CI/CD パイプラインを実現する5つの約束

[概要](https://jawsdays2019.jaws-ug.jp/session/1648/)

[スライド](https://www.slideshare.net/ssuser9d40ae/jaws-days-2019pipelineisgod)

導入前に聞いておきたかったなと言う印象を受けました。

* パイプラインファースト

terraformのCI/CDを実現しようと意気込んでいましたが、最終的には後回しとしました。

これはタイミングの調整をしなければいけない、terraformの挙動を知らない人がCI/CDの管理は出来ない、といった理由からでした。

しかし、最初から育てていけばよかったなと後悔しています。

せっかくコード化しても、バージョン管理やレビュー以外の恩恵を受けられないからです。

* 自動化されたパイプラインを維持する

アプリケーションの方のパイプラインの維持は思いの外大変だなという印象です。

まず関係する技術的な要素が多い。

CIとはなんぞや、CI/CDツール(CircleCI/Jenkins/CodePipeline/CodeBuild)は知っているか、ということです。

はじめから知ってる人を集めれば良いのですが、知らない人が多い中では学習コストがかなり高く付きます。

これらを知らなくても済むようにSlackに逐一何が起きているのか、ログがどこにあるのか、といった情報は送りますが、
その仕組み自体のメンテナンス性が、初学者にとってはきつい気がしています。

* 柔軟なパイプラインを維持する
* パイプラインのUXを継続的に改善していく

ここに関しては毎回疑問に思うのは、パイプラインを変更したときの、パイプライン自身のテストはどうするんだろうか、というところです。

単純に開発環境で実行してみればいいという話ではあるのですが、せっかくなので自動化したいとか、そういった要望はある気がしていて、そのへんのテストをどう実装しているのかが気になります。

* パイプラインは神である

パイプライン以外でリリースするなと言う話ですね。

パイプラインの処理自体を高速化しないと使いたがらなくなるというところがキツくて、使ってもらいたがるような速度にしたいと常々思っています。

推奨されている値が10分以下という記事をよく見かけますが、それも長いように思います。

ただこれ以上かかっている現状があり、まずいなと思っています。

近いうちになんとかします。

## 自社基盤で運用していた事業用サービスをAWS Fargate/Lambda等を活用しAWS上で再構築！苦労話もあるよ。 

[概要](https://jawsdays2019.jaws-ug.jp/session/1941/)

なるほど、と思う話は

* Fargateを(バッチのように)使っていたらNAT Gatewayのコストが跳ね上がった

原理的にはVPC内からECRのイメージをpullしているので、pullするコストがかかるという話ですね。

自分はFargateをバッチのように使っていないため、そこまでコストが跳ね上がることはなさそうですが、
そのように使う場合は話にあったとおりPrivateLinkを利用しようと思います。


## Infrastructure as Codeに疲れたので、僕たちが本来やりたかったことを整理する

[概要](https://jawsdays2019.jaws-ug.jp/session/1119/)

今日のメインディッシュと思っていたものです。

ただ、聞いていくうちに、分かる〜、という同意とともに、だいたい考えていたことが一緒で、得られた知見はあまり無かったかもしれません。

要点を一言でまとめると

* ポチポチで作れば3分で済むのに、わざわざterraformのコード化する必要があるのか？

という点です。

もちろんコード化することの恩恵は色々ありますが、確実に時間を犠牲にするのは間違いありません。

学習コストも高いです。

私が考えていたことは

* コードを書かなくて済むこと
* バージョン管理ができること
* 差分が分かること
* コードから再構築できること
* 自動化できること
* レビューができること

これらができるならマネコンからポチポチ作ってもいいと思っています。

個人的に考える実現方法は

* 現状のスナップショットを、自分たちが利用しているstackの分割定義で抽象化された状態で、terraformのコードをダンプできること

です。

もちろんterraformでなくても問題ありません。

terraformingというツールがこの考えに利用できそうではありますが、あれは抽象化せず、そのままダンプをしています。

例えば、EC2に紐付けるSecurity Groupを定義した時、EC2のリソースにはaws_security_group.hogehoge.idといった変数を利用したいはずです。

しかし、terraformingでダンプした場合は、sg-xxxxxxとIDがそのまま出力されます。

これは他のアカウントで使おうとしても使い物になりません。

このあたりの関連を自分で定義した範囲で出力の抽象化ができれば、今回の考えに近いことができるなと思いました。

と書いてて、実装したくなってきました。


## まとめ

初めてJAWSに参加しました。

正直自分の実装したものに不安だらけで、何かCI/CDやIaCなどに参考になるものがないかと思って聞きに行きました。

それで話を聞いていると、みんな同じところで悩んで、同じような解決手法になるんだなという結論に至りました。

自分ももう少しアウトプットして世間に貢献したほうが良いのかなという気持ちになってきました。
