---
title:  "Finish reading 'Terraform Up ＆ Running'"
date:   2020-03-21 14:30:00 +0900
categories: tech
tags: terraform
layout: post
---

Terraform Up ＆ Runningを読みました。
素晴らしい本だったので、現状やっていることとの差と今後使えそうというところを書こうと思います。


## はじめに

どういった内容かというと、軽い例題とともに、terraformをどう本番に適用していくかが書かれています。
本番環境に向けて考えなくてはいけない部分と、自動化に向けてどういうことことも含めて紹介されていました。

大部分は通った道だと感じましたが、いくつか知見がありました。
自分がやっていることはおいておいて、新たに得られた知見をいくつかまとめておこうと思います。

* for_eachがいつの間にか素敵になっていた
* moduleのバージョン管理
* テストの方法
* 本番環境で考えなくちゃいけないリスト

## for_eachがいつの間にか素敵になっていた

v0.12.1以降あまり機能アップデートを追っていなかったので、全然気づきませんでした。
素敵になったのはv0.12.6以降なので、バージョンの機能を追うのって重要だなと感じます。

リソースを複数作るときにcountだとインデックスがずれて、以下のようなリソースを作って、
r2を消したとき、r2,r3が消えて、r2が再作成されるという挙動をしていました。

大量のリソースを作りたいときcountは必須でしたが、この挙動があるためかなり使いにくい状況でした。

これがfor_eachを使うことで改善できるようになったのはかなり僥倖です。


```hcl
locals {
  names = ["r1", "r2", "r3"]
}

resource "hoge" "fuga" {
  count = "${length(names)}"
  ...
}

```

## moduleのバージョン管理

本文中はgitのタグを使って管理しろという話でした。

public githubにおく必要ありと書かれてましたので、GHEを利用できるかはいまいち分かってません。

modulesは自分では使っていません。

理由は開発中のmoduleが本番にも反映されそうになって使いにくいという理由からでした。

確かにこれを使えば解決出来そうな気がします。

自分は最初ブランチで解決しようとしていました。

タグを使うのは正直目から鱗でした。

むしろ何で考えなかったんだろうと若干恥ずかしくもなりました。

ただ、結局自分のところではこれは使いにくいかなという感覚です。

厳密な理屈を考える必要はあるのでしょうが、
チームの文化やgitなどを知らない人がやりやすい手段をとりたいこと、
再利用を頻繁にせずあまり大きくない会社であること、
などからmoduleを使うと返って混乱しそうというのが前提にあります。

とはいえ、周囲の人はこの辺どうやってるんだろうと思っていたので、なるほどと思いました。


## テストの方法

テストをどうやろうかはさんざん迷いました。

terraformを導入するとき、

* packer
* ansible
* terraform
* AWS
* IaC
* テスト駆動開発

といったツールや概念をチームの人はまったく知らない状態です。

これらを勉強して、さらにテストコードまで書かせるとなるとかなり負担が大きいのではないかなという感覚でした。
最初に手に取ってもらうのが、

* terraform
* AWS

だけにして、他のツールや概念はあとづけしていく方針をとったため、テストはマニュアルでやるということに決めていました。

そのため、terratestを使ったテストの方法を示してくれているのは非常に助かります。

terratestはまさに使い始めようとしているところだったのでなおさらです。

特にSKIPの部分です。確かにリソース作るの時間がかかるから、リソースの作成は最初にやってしまって、validationの部分でリソースの間違いなどコードを調整などしておけば良いというわけです。

## 本番環境で考えなくちゃいけないリスト

感覚でやっていた部分が厳密なチェックリストにされているの非常に助かりました。

会社にリリース基準が無くて、個人的にこのようなチェックリストを作っていたりしました。
確かにこの辺会社で共有した方が良いなと、むしろ何でやってなかったんだろうと恥ずかしくなりました。

自分のチェックリストには不足している部分がいくつかあったのでこれを加えていきたいなと感じています。
あのチェックリストに無かった部分も自分は持っているので、ここは会社によるところなのかなと感じました。

## 終わりに

確かに言われてみれば何でやってないんだろう？と感じることが多く、他者の視点を取り入れることは非常に重要だなと感じました。
